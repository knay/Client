{% extends "::baseAffichage.html.twig" %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('bundles/imerirproduit/css/ajoutLigneProduit.css') }}"/>
{% endblock %}

{% block title_page %}
    Commandes fournisseurs
{% endblock %}

{% block title_ajout %}
    {% if app.request.attributes.get('_route')=='imerir_modification_fournisseur' %}
        MODIFICATION
    {% else %}
        AJOUT
    {% endif %}
{% endblock %}

{% block fournisseurBlock %}
menuSelected
{% endblock %}


{% block ajout %}
    {% if app.request.attributes.get('_route')=='imerir_creation_commande_fournisseur' %}
        <form action="{{ path('imerir_validation_creation_fournisseur') }}" method="post" id="formulaire_creation_commande_fournisseur">
            <table id="tableau_input">
                <tr>
                    <td>
                        <label for="fournisseur">Fournisseur </label>
                    </td>
                    <td>
                        <select name="fournisseur">
                            <option></option>
                            {% for i in liste_fournisseurs %}
                                <option>{{ i.nom }}</option>
                            {% endfor %}
                        </select>
                    </td>
                </tr>
            </table>
            <div id="lst_commande">
                <table class="tableau" id="tableau">
                    <th></th>
                    <th>Article</th>
                    <th>Quantité souhaitée</th>
                    <tr>
                        <td>
                            <i class="fa fa-plus-square ajout ajouter"></i>
                        </td>
                        <td>
                            <input type="text" width="80" name="article"/>
                            <label class="fa fa-th recherche rechercher"></label>
                        </td>
                        <td>
                            <input type="number" name="qty">
                        </td>
                    </tr>
                </table>
            </div>

            {#champs pour l'adresse#}
            {#
            <div id="lst_adresse">
                <table class="tableau" id="tableau">
                    <tr>
                        <th></th>
                        <th class="titre_lst">Pays</th>
                        <th class="titre_lst">Ville</th>
                        <th class="titre_lst">Code postal</th>
                        <th class="titre_lst">N° voie</th>
                        <th class="titre_lst">Voie</th>
                        <th class="titre_lst">N° appartement</th>
                        <th class="titre_lst">Téléphone fixe</th>
                    </tr>
                    {% if detail_adresse.adresse is defined %}
                        {% for i in detail_adresse.adresse %}
                            <tr>
                                <td>
                                    <i class="fa fa-minus-square supprimer"></i>
                                </td>
                                <td>
                                    <input type="text" name="adresse{{ nbAdresse }}" value="{{ i.valeurAdresse }}"/>
                                </td>
                            </tr>
                            {% set nbAdresse = nbAdresse + 1 %}
                        {% endfor %}
                    {% endif %}
                    <tr class="last">
                        <td><i class="fa fa-plus-square ajout ajouter"></i></td>
                        <td><input type="text" name="pays{{ nbAdresse }}"/></td>
                        <td><input type="text" name="ville{{ nbAdresse }}"/></td>
                        <td><input type="text" name="code_postal{{ nbAdresse }}"/></td>
                        <td><input type="text" name="num_voie{{ nbAdresse }}"/></td>
                        <td><input type="text" name="voie{{ nbAdresse }}"/></td>
                        <td><input type="text" name="num_appartement{{ nbAdresse }}"/></td>
                        <td><input type="text" name="telephone_fixe{{ nbAdresse }}"/></td>
                    </tr>
                </table>
            </div>
            #}
        </form>
    {% endif %}


{% endblock %}

{% block recherche %}
    <form action="{{ path('imerir_creation_commande_fournisseur') }}" method="post">
        <label for="recherche_commande_fournisseur_nom_fournisseur">Nom fournisseur :</label>
        <input type="text" name="recherche_fournisseur_nom_fournisseur">
        <label for="recherche_fournisseur_article">Article :</label>
        <input type="text" name="recherche_fournisseur_article">
        <label for="recherche_commande_fournisseur_id">Numéro de commande :</label>
        <input type="text" name="recherche_commande_fournisseur_id">
        <input type="submit">
    </form>
{% endblock %}

{% block table %}
    <tr class="liste_fournisseurs"><th>Nom fournisseur</th><th>Date de la commande</th><th>Numéro de la commande</th>
        <th>Article</th><th>Quantité souhaitée</th><th>Quantité reçue</th></tr>
    {% for i in liste_commandes %}

        <tr><td>{{ i.fournisseur_nom }}
                {#
                <form method="post" action="{{ path('imerir_modification_fournisseur') }}" style="display: none">
                    <input type="hidden" name="id_f" value="{{ i.id }}">
                    <input type="hidden" name="nom_f" value="{{ i.nom }}">
                    <input type="hidden" name="email_f" value="{{ i.email }}">
                    <input type="hidden" name="telephone_portable_f" value="{{ i.telephone_portable }}">
                    <input type="hidden" name="reference_client_f" value="{{ i.reference_client }}">
                    <input type="hidden" name="notes_f" value="{{ i.notes }}">
                </form>
                #}
            </td>
            <td>{{ i.date_commande }}</td>
        <td>{{ i.commande_id }}</td><td>{{ i.code_barre}}</td><td>{{ i.quantite_souhaite }}</td><td>{{ i.quantite_recu }}</td></tr>
    {% endfor %}
{% endblock %}

{% block javascripts %}
<script>
    //variables
    var numLigneCommande = 200;
    ///
    $('tr').click(function () {
        $(this).children('td').children('form').submit();
    });

    /**
    * Fonction permettant de réagir lors du click sur ajouter un élément.
    * Cette fonction vérfie si un valeur est précisé, et si oui, ajoute
    * un élément.
    */
    $("#lst_commande").find('.ajouter').click(
            function ajoutItem() {
                var last = $("#lst_commande").find('tr').last();
                var input = $(last).find('input');
                /*
                if ($(input).val() === "") {
                    input.select();
                }
                */
               // else {
                $("#lst_commande").children("table").append(
                '<tr><td><i class="fa fa-plus-square ajout ajouter"></i></td>'
                +'<td><input type="text" width="80" name="article'+numLigneCommande+'"/><label class="fa fa-th recherche rechercher"></label></td>'
                +'<td><input type="number" name="qty'+numLigneCommande+'"></td>'
                +'<td><input type="text" name="prix'+numLigneCommande+'"></td></tr>'
                );

                last.find("i").toggleClass("ajout");
                last.find("i").toggleClass("supprimer");
                last.find("i").toggleClass("fa-plus-square");
                last.find("i").toggleClass("fa-minus-square");
                last.find("i").toggleClass("ajouter");
                last.toggleClass("last");

                $(this).unbind('click');
                $("#lst_commande").find('.ajouter').click(ajoutItem);
                $("#lst_commande").find('.supprimer').click(supprimerItem);

                numAdresse++;
                //}
            }
    );
    $('.supprimer').click(supprimerItem); // On bind le click sur le boutton moins avec la fonction de suppression de ligne

    /**
     * Cette fonction permet de supprimer une valeur d'attribut.
     * Elle est appelée lorsque l'on clic sur le boutton moins.
     */
    function supprimerItem() {
        var est_visible = $(this).parent().find('.est_visible');
        if(est_visible.length == 0){
            $(this).parent().parent().remove();
        }
        else{
            $(this).parent().parent().hide();
            est_visible.val('0');
        }
    }
</script>
{% endblock %}
