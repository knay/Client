{% extends "::baseAffichage.html.twig" %}

{% set nbAttribut = 0 %}
{% set nbLigneProduit = 0 %}

{% block title_page %}
Attributs
{% endblock %}

{% block title %}
ALBA - Attributs
{% endblock %}

{% block stylesheets %}
	<link rel="stylesheet" href="{{ asset('bundles/imerirproduit/css/ajoutattribut.css') }}">
{% endblock %}

{% block ajout %}
<form action="{{ path('imerir_produit_save_attributs') }}" method="post">
	<div id="divNom">
		<label for="nom">Nom : </label>
		{% if detail_attribut.nom is defined %} 
		<input type="text" name="nom" value="{{ detail_attribut.nom }}"/>
		{% else %}
		<input type="text" name="nom"/>
		{% endif %}
		{% if detail_attribut.id is defined %}
		<input type="hidden" name="id" value="{{ detail_attribut.id }}">
		{% endif %}
		<input type="submit">
	</div>
	<div id="lst_attribut">
		<table>
			<tr>
				<th></th>
				<th class="titre_lst">Liste des valeurs possibles</th>
			</tr>
			{% if detail_attribut.attribut is defined %}
				{% for i in detail_attribut.attribut %}
					<tr>
						<td>
							<i class="fa fa-minus-square supprimer"></i>
						</td>
						<td>
							<input type="text" name="attribut{{ nbAttribut }}" value="{{ i.valeurAttr }}"/>
						</td>
					</tr>
					{% set nbAttribut = nbAttribut + 1 %}
				{% endfor %}
			{% endif %}
			<tr class="last">
				<td>
					<i class="fa fa-plus-square ajout ajouter"></i>
				</td>
				<td>
					<input type="text" name="attribut{{ nbAttribut }}"/>
				</td>
			</tr>
		</table>
	</div>
	<div id="lst_ligne_produit">
		<table>
			<tr>
				<th></th>
				<th class="titre_lst">Lignes de produits concernées</th>
			</tr>
			{% set lastProduitSelected = 0 %}
			{% if detail_attribut.ligneProduit is defined %}
				{% for i in detail_attribut.ligneProduit %}
					<tr>
						<td>
							{% if loop.last %}
								{# Le dernier c'est un boutton ajouter et pas supprimer qu'il faut mettre #}
								<i class="fa fa-plus-square ajout ajouter"></i>
							{% else %}
								<i class="fa fa-minus-square supprimer"></i>
							{% endif %}
						</td>
						<td class="{% if loop.last %}last{% endif %}">
							<select name="lg_produit{{ nbLigneProduit }}">
								{% set nbLigneProduit = nbLigneProduit + 1 %}
								{% for j in ligne_produit %}
									{% if j.nom == i.nomLigneProduit %}
										{% if nbLigneProduit > lastProduitSelected %}
											<option selected>{{ j.nom }}</option>
											{% set lastProduitSelected = nbLigneProduit %}
										{% else %}
											<option>{{ j.nom }}</option>
										{% endif %}
									{% else %}
										<option>{{ j.nom }}</option>
									{% endif %}
								{% endfor %}
							</select>
						</td>
					</tr>
				{% endfor %}
			{% else %}
				<tr class="last">
					<td><i class="fa fa-plus-square ajout ajouter"></i></td>
					<td>
						<select name="lg_produit1">
						{% for j in ligne_produit %}
							<option>{{ j.nom }}</option>
						{% endfor %}
						</select>
					</td>
				</tr>
			{% endif %}
		</table>
	</div>
</form>
{% endblock %}

{% block recherche %}
<form action="{{ path('imerir_produit_modif_attributs') }}" method="post">
	<label for="rechNom">Nom :</label><input type="text" name="rechNom">
	<input type="submit">
</form>
{% endblock %}

{% block table %}
	<tr><th>Nom</th></tr>
{% for i in lst_attribut %}
	<tr>
		<td>
			<form method="post" action="{{ path('imerir_produit_modif_attributs') }}" style="display: none">
				<input type="hidden" name="id" value="{{ i.id }}">
			</form>
			{{ i.nom }}
		</td>
	</tr>
{% endfor %}
{% endblock %}

{% block javascripts %}
<script>
	var numAttribut = 200;
	var numLigne = 200;
	var selectCourant = 0;

	$('tr').click(function () {
		$(this).children('td').children('form').submit();
	});
	
	/**
	 * Fonction permettant de réagir lors du click sur ajouter un élément.
	 * Cette fonction vérfie si un valeur est précisé, et si oui, ajoute
	 * un élément.
	 */
	 $("#lst_attribut").find('.ajouter').click(
		function ajoutItem() {
			var last = $("#lst_attribut").find('tr').last();
			var input = $(last).find('input');
			if ($(input).val() === "") {
				input.select();
			}
			else {
				$("#lst_attribut").children("table").append('<tr><td><i class="fa fa-plus-square ajout ajouter"></i></td><td><input type="text" name="attribut'+numAttribut+'"/></td></tr>');

				last.find("i").toggleClass("ajout");
				last.find("i").toggleClass("supprimer");
				last.find("i").toggleClass("fa-plus-square");
				last.find("i").toggleClass("fa-minus-square");
				last.find("i").toggleClass("ajouter");
				last.toggleClass("last");

				$(this).unbind('click');
				$("#lst_attribut").find('.ajouter').click(ajoutItem);
				$("#lst_attribut").find('.supprimer').click(supprimerItem);

				numAttribut++;
			}
		}
	);

	
	 $('.supprimer').click(supprimerItem); // On bind le click sur le boutton moins avec la fonction de suppression de ligne
	 
	 /**
	  * Cette fonction permet de supprimer une valeur d'attribut.
	  * Elle est appelée lorsque l'on clic sur le boutton moins.
	  */
	 function supprimerItem() {
	 	 $(this).parent().parent().remove();
	 }

	 /**
	 * Fonction permettant de réagir lors du click sur ajouter un élément.
	 * Cette fonction vérfie si un valeur est précisé, et si oui, ajoute
	 * un élément.
	 */
	 $("#lst_ligne_produit").find('.ajouter').click(
		function ajoutLigne() {
			var last = $("#lst_ligne_produit").find('tr').last();
			var tableau = $("#lst_ligne_produit").children("table");
			
			clone = last.clone().appendTo(tableau);
			clone.find('select').attr("name", "lg_produit"+numLigne);
			
			last.find("i").toggleClass("ajout");
			last.find("i").toggleClass("supprimer");
			last.find("i").toggleClass("fa-plus-square");
			last.find("i").toggleClass("fa-minus-square");
			last.find("i").toggleClass("ajouter");
			last.toggleClass("last");

			numLigne++;

			$(this).unbind('click');
			$("#lst_ligne_produit").find('.ajouter').click(ajoutLigne);
			$("#lst_ligne_produit").find('.supprimer').click(supprimerItem);
		}
	);

	 $("#lst_ligne_produit").children('p').children('.supprimer').click(supprimerItem);
</script>
{% endblock %}

